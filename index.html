<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script>
      function generarReferencias() {
        const contenedor = document.getElementById('referencias-container');
        contenedor.innerHTML = ''; // limpiar contenedor anterior
        const num = parseInt(document.getElementById('cantidadReferencias').value);

        for (let i = 0; i < num; i++) {
          const div = document.createElement('div');
          div.innerHTML = `
            <fieldset style="margin-top: 15px; padding: 10px; border: 1px solid #ccc;">
              <legend>Referencia ${i + 1}</legend>
              <label>Nombre de la referencia:</label>
              <input type="text" name="referencia_${i}" required><br><br>
              <label>Cantidad producida:</label>
              <input type="number" name="cantidad_${i}" required><br><br>
              <table border="1">
                <tr><th>Tipo de Daño</th><th>Cantidad</th></tr>
                <tr><td>Burbuja</td><td><input type="number" name="burbuja_${i}" value="0"></td></tr>
                <tr><td>Roto</td><td><input type="number" name="roto_${i}" value="0"></td></tr>
                <tr><td>Crudo</td><td><input type="number" name="crudo_${i}" value="0"></td></tr>
                <tr><td>Quemado</td><td><input type="number" name="quemado_${i}" value="0"></td></tr>
                <tr><td>Otro</td><td><input type="number" name="otro_${i}" value="0"></td></tr>
              </table>
            </fieldset>
          `;
          contenedor.appendChild(div);
        }
      }

      function enviarFormulario(e) {
        e.preventDefault();

        const formData = new FormData(document.getElementById('formulario'));
        const cantidadRefs = parseInt(document.getElementById('cantidadReferencias').value);

        const payload = {
          operario: formData.get('operario'),
          referencias: [],
          cantidades: [],
          fallosPorReferencia: {},
          anomalia: formData.get('anomalia'),
          descripcionAnomalia: formData.get('descripcion')
        };

        for (let i = 0; i < cantidadRefs; i++) {
          const ref = formData.get(`referencia_${i}`);
          const cant = formData.get(`cantidad_${i}`);

          payload.referencias.push(ref);
          payload.cantidades.push(cant);

          payload.fallosPorReferencia[ref] = {
            Burbuja: parseInt(formData.get(`burbuja_${i}`) || 0),
            Roto: parseInt(formData.get(`roto_${i}`) || 0),
            Crudo: parseInt(formData.get(`crudo_${i}`) || 0),
            Quemado: parseInt(formData.get(`quemado_${i}`) || 0),
            Otro: parseInt(formData.get(`otro_${i}`) || 0),
          };
        }

        fetch("https://script.google.com/macros/s/AKfycbz8KC794Bnsqu1dBX98NJs9evvanoljStz6x9l5ETm40VoP54JBUEuQwkElaKBqwlM6/exec", {
          method: "POST",
          body: JSON.stringify(payload),
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(res => res.text())
        .then(res => alert("Formulario enviado correctamente"))
        .catch(err => alert("Error al enviar formulario: " + err));
      }
    </script>
  </head>
  <body>
    <h2>CAUCHOS JTORRES</h2>
    <form id="formulario" onsubmit="enviarFormulario(event)">
      <label>Fecha:</label>
      <input type="date" name="fecha" required><br><br>

      <label>Nombre del operario:</label>
      <select name="operario" required>
        <option value="">Seleccione un operario</option>
        <option value="Diego Lopez">Diego Lopez</option>
        <!-- Agrega más opciones aquí -->
      </select><br><br>

      <label>¿Cuántas referencias fabricó hoy?</label>
      <input type="number" id="cantidadReferencias" onchange="generarReferencias()" required><br><br>

      <div id="referencias-container"></div>

      <label>¿Hubo alguna anomalía o novedad en la jornada?</label>
      <select name="anomalia" required>
        <option value="No">No</option>
        <option value="Sí">Sí</option>
      </select><br><br>

      <label>Descripción de la anomalía o novedad:</label><br>
      <textarea name="descripcion" rows="3" cols="40"></textarea><br><br>

      <input type="submit" value="Enviar">
    </form>
  </body>
</html>
